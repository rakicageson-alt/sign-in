<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­çº§è€ƒå‹¤è¡¨</title>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: #1f2d3d; text-align: center; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { display: block; width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 6px; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        .btn-outline { background: white; color: #007aff; border: 1px solid #007aff; }
        .btn-danger { background: #ff3b30; margin-top: 20px;}

        /* è¾“å…¥æ¡† */
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
        
        /* è¡¨æ ¼æ ·å¼ (ä»¿Excel) */
        .table-wrapper { overflow-x: auto; border: 1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
        th { background: #f8f9fa; font-weight: bold; position: sticky; left: 0; z-index: 1;}
        td:first-child, th:first-child { position: sticky; left: 0; background: #fff; z-index: 2; border-right: 2px solid #ccc;} 
        th:first-child { background: #f8f9fa; }
        
        /* ç­¾åˆ°æ‰“å‹¾ */
        .check-mark { color: green; font-weight: bold; font-size: 16px; }
        
        /* å­¦ç”Ÿåˆ—è¡¨ç½‘æ ¼ */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .student-card { border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 6px; background: #fff; cursor: pointer; transition: all 0.2s; }
        .student-card.signed { background: #e8ffea; border-color: #28a745; color: #28a745; pointer-events: none; }
        .student-card:active { background: #f0f0f0; }
        .s-id { font-size: 12px; color: #999; margin-bottom: 4px; }
        .s-name { font-weight: bold; font-size: 16px; }

        .hidden { display: none; }
        .status { padding: 10px; text-align: center; border-radius: 4px; margin-bottom: 10px; font-size: 14px; }
        .error { background: #fee; color: #d00; }
        .success { background: #efe; color: #0a0; }
    </style>
</head>
<body>

    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div id="admin-panel" class="card hidden">
        <h2>ğŸ“‹ è€ƒå‹¤ç®¡ç†å‘˜</h2>
        
        <!-- æ­¥éª¤1: å¯¼å…¥åå• -->
        <div style="border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
            <h3>1. ç­çº§åå•è®¾ç½®</h3>
            <p style="font-size:12px; color:#666;">è¯·ä»Excelå¤åˆ¶ä¸¤åˆ—å†…å®¹ï¼ˆå­¦å· å§“åï¼‰ï¼Œç›´æ¥ç²˜è´´åœ¨ä¸‹é¢ï¼š</p>
            <textarea id="roster-input" placeholder="ä¾‹å¦‚ï¼š
25101 å¼ ä¸‰
25102 æå››"></textarea>
            <button class="btn btn-outline" onclick="importRoster()">æ›´æ–°ç­çº§åå•</button>
        </div>

        <!-- æ­¥éª¤2: å‘èµ·ç­¾åˆ° -->
        <div>
            <h3>2. å‘èµ·ä»Šæ—¥ç­¾åˆ° (30ç±³)</h3>
            <div id="gps-status" style="font-size:12px; color:#666; text-align:center; margin-bottom:10px;">å®šä½ä¸­...</div>
            <button class="btn" id="start-btn" onclick="startSign()">ğŸ“ è®¾å®šå½“å‰ä½ç½®å¹¶ç”Ÿæˆé“¾æ¥</button>
            <div id="share-box" class="hidden" style="margin-top:10px;">
                <input type="text" id="share-link" style="width:100%; padding:10px;" readonly>
                <p style="font-size:12px; color:red;">å°†æ­¤é“¾æ¥å‘åˆ°ç¾¤é‡Œ</p>
            </div>
        </div>

        <!-- æ­¥éª¤3: æŸ¥çœ‹æŠ¥è¡¨ -->
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>3. è€ƒå‹¤æ±‡æ€»è¡¨</h3>
            <button class="btn btn-outline" onclick="loadReport()">åˆ·æ–°æŠ¥è¡¨</button>
            <div class="table-wrapper" style="margin-top:10px;">
                <table id="report-table">
                    <!-- JSåŠ¨æ€ç”Ÿæˆ -->
                </table>
            </div>
        </div>
    </div>

    <!-- å­¦ç”Ÿç­¾åˆ°é¢æ¿ -->
    <div id="student-panel" class="card hidden">
        <h2>ğŸ‘‹ ç°åœºç­¾åˆ°</h2>
        <div id="user-status" class="status">æ­£åœ¨è·å–ä½ç½®...</div>
        
        <div id="roster-list" class="hidden">
            <p style="text-align:center; color:#666;">è¯·ç‚¹å‡»ä½ çš„åå­—è¿›è¡Œç­¾åˆ°</p>
            <div class="student-grid" id="student-grid">
                <!-- åˆ—è¡¨ç”ŸæˆåŒº -->
            </div>
        </div>
    </div>

<script>
    // ================= é…ç½®åŒº =================
    const LEANCLOUD_APP_ID = "ä½ çš„AppID";     
    const LEANCLOUD_APP_KEY = "ä½ çš„AppKey";   
    const LEANCLOUD_SERVER_URL = "https://ä½ çš„åŸŸå.leanapp.cn"; 
    // =========================================

    if(LEANCLOUD_APP_ID === "ä½ çš„AppID") alert("è¯·å…ˆé…ç½®ä»£ç ä¸­çš„ LeanCloud IDå’ŒKeyï¼");

    AV.init({ appId: LEANCLOUD_APP_ID, appKey: LEANCLOUD_APP_KEY, serverURL: LEANCLOUD_SERVER_URL });

    // URLå‚æ•°å¤„ç†
    const urlParams = new URLSearchParams(window.location.search);
    const MODE = urlParams.get('mode'); 
    const TARGET_LAT = parseFloat(urlParams.get('lat'));
    const TARGET_LNG = parseFloat(urlParams.get('lng'));
    
    // é™åˆ¶è·ç¦» 30ç±³
    const LIMIT_DIST = 30; 

    // åˆå§‹åŒ–
    window.onload = function() {
        if (MODE === 'sign' && TARGET_LAT && TARGET_LNG) {
            initStudentPage();
        } else {
            initAdminPage();
        }
    };

    // ================== ç®¡ç†å‘˜é€»è¾‘ ==================
    function initAdminPage() {
        document.getElementById('admin-panel').classList.remove('hidden');
        navigator.geolocation.getCurrentPosition(
            res => { document.getElementById('gps-status').innerText = `ç²¾åº¦: Â±${Math.round(res.coords.accuracy)}ç±³`; },
            err => { document.getElementById('gps-status').innerText = "âŒ è¯·å…è®¸å®šä½æƒé™"; }
        );
    }

    // 1. å¯¼å…¥åå•
    async function importRoster() {
        const text = document.getElementById('roster-input').value.trim();
        if(!text) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
        
        const lines = text.split('\n');
        const students = [];
        
        lines.forEach(line => {
            // æ”¯æŒåˆ¶è¡¨ç¬¦æˆ–ç©ºæ ¼åˆ†éš”
            const parts = line.trim().split(/[\t\s]+/);
            if(parts.length >= 2) {
                students.push({ sid: parts[0], name: parts[1] });
            }
        });

        if(students.length === 0) return alert("æ ¼å¼æ— æ³•è¯†åˆ«ï¼Œè¯·ç¡®ä¿æ¯è¡Œæ˜¯ï¼šå­¦å· å§“å");

        if(!confirm(`è¯†åˆ«åˆ° ${students.length} äººï¼Œç¡®å®šè¦è¦†ç›–æ—§åå•å—ï¼Ÿ`)) return;

        // ä¿å­˜åˆ°LeanCloud Rosterè¡¨
        // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å…ˆæ¸…ç©ºå†æ·»åŠ ï¼Œæˆ–è€…åªå­˜ä¸€ä¸ªå¤§çš„JSONå¯¹è±¡
        const Roster = AV.Object.extend('ClassRoster');
        const query = new AV.Query('ClassRoster');
        try {
            const old = await query.first();
            const rosterObj = old || new Roster();
            rosterObj.set('list', students);
            await rosterObj.save();
            alert("âœ… åå•å·²æ›´æ–°ï¼");
        } catch (e) {
            alert("ä¿å­˜å¤±è´¥ï¼š" + e.message);
        }
    }

    // 2. å‘èµ·ç­¾åˆ°
    function startSign() {
        if (!navigator.geolocation) return alert('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
        const btn = document.getElementById('start-btn');
        btn.disabled = true; btn.innerText = "è·å–ä¸­...";

        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            const url = `${window.location.href.split('?')[0]}?mode=sign&lat=${lat}&lng=${lng}`;
            
            document.getElementById('share-box').classList.remove('hidden');
            document.getElementById('share-link').value = url;
            btn.innerText = "âœ… é“¾æ¥å·²ç”Ÿæˆ";
            btn.disabled = false;
        }, err => {
            alert("å®šä½å¤±è´¥ï¼š" + err.message);
            btn.disabled = false;
        }, { enableHighAccuracy: true });
    }

    // 3. ç”ŸæˆExcelé£æ ¼æŠ¥è¡¨
    async function loadReport() {
        const table = document.getElementById('report-table');
        table.innerHTML = '<tr><td>åŠ è½½ä¸­...</td></tr>';

        try {
            // è·å–åå•
            const qRoster = new AV.Query('ClassRoster');
            const rosterData = await qRoster.first();
            if(!rosterData) return alert("è¯·å…ˆå¯¼å…¥åå•");
            const students = rosterData.get('list'); // [{sid, name}, ...]

            // è·å–æ‰€æœ‰ç­¾åˆ°è®°å½•
            const qRecord = new AV.Query('SignInRecord');
            qRecord.limit(1000); // å‡è®¾ä¸è¶…è¿‡1000æ¡ï¼Œå¤šäº†éœ€åˆ†é¡µ
            qRecord.ascending('date'); // æŒ‰æ—¥æœŸæ’åº
            const records = await qRecord.find();

            // æ•´ç†æ—¥æœŸåˆ— (å»é‡)
            const dates = [...new Set(records.map(r => r.get('date')))];
            
            // æ„å»ºè¡¨å¤´
            let html = `<thead><tr>
                <th style="min-width:100px;">å­¦å· | å§“å</th>
                ${dates.map(d => `<th>${d}</th>`).join('')}
            </tr></thead><tbody>`;

            // æ„å»ºè¡Œæ•°æ®
            students.forEach(stu => {
                html += `<tr>`;
                html += `<td style="font-weight:bold;">${stu.sid} ${stu.name}</td>`;
                
                // éå†è¯¥å­¦ç”Ÿæ¯ä¸€å¤©çš„è®°å½•
                dates.forEach(date => {
                    // æŸ¥æ‰¾è¯¥å­¦ç”Ÿåœ¨è¯¥æ—¥æœŸçš„è®°å½•
                    const hasSigned = records.find(r => 
                        r.get('date') === date && r.get('sid') === stu.sid
                    );
                    html += `<td>${hasSigned ? '<span class="check-mark">âœ”</span>' : ''}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody>`;
            table.innerHTML = html;

        } catch (e) {
            alert("åŠ è½½æŠ¥è¡¨å¤±è´¥ï¼š" + e.message);
        }
    }

    // ================== å­¦ç”Ÿé€»è¾‘ ==================
    async function initStudentPage() {
        document.getElementById('student-panel').classList.remove('hidden');
        const statusEl = document.getElementById('user-status');

        // 1. æ£€æŸ¥ä»Šæ—¥è®¾å¤‡é” (LocalStorage)
        const todayStr = new Date().toLocaleDateString();
        const lastSignDate = localStorage.getItem('last_sign_date');
        
        if (lastSignDate === todayStr) {
            statusEl.className = "status success";
            statusEl.innerText = "âœ… æ‚¨ä»Šæ—¥å·²ç­¾åˆ°ï¼Œè¯·å‹¿é‡å¤æ“ä½œ";
            // è¿™é‡Œæˆ‘ä»¬ä¾ç„¶åŠ è½½åˆ—è¡¨ï¼Œä½†è®©å…¶ä¸å¯ç‚¹ï¼Œæˆ–è€…ç›´æ¥ä¸åŠ è½½
            // ä¸ºäº†å±•ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œä½†åœ¨ç‚¹å‡»æ—¶æ‹¦æˆª
        }

        // 2. æ ¡éªŒè·ç¦»
        navigator.geolocation.getCurrentPosition(async pos => {
            const dist = getDistance(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LNG);
            
            if (dist > LIMIT_DIST) {
                statusEl.className = "status error";
                statusEl.innerText = `â›” è¶…å‡ºèŒƒå›´ (è·ç¦»${dist}ç±³)\nè¯·åœ¨æ•™å®¤${LIMIT_DIST}ç±³èŒƒå›´å†…æ‰“å¼€`;
                return; 
            }

            statusEl.className = "status success";
            statusEl.innerText = `ğŸ“ ä½ç½®ç¬¦åˆ (è¯¯å·®${dist}ç±³)`;
            
            // 3. åŠ è½½åå•
            await renderStudentList(todayStr);

        }, err => {
            statusEl.className = "status error";
            statusEl.innerText = "âŒ æ— æ³•å®šä½ï¼Œè¯·å¼€å¯æ‰‹æœºå®šä½æƒé™";
        }, { enableHighAccuracy: true });
    }

    async function renderStudentList(todayStr) {
        const grid = document.getElementById('student-grid');
        document.getElementById('roster-list').classList.remove('hidden');
        grid.innerHTML = "åŠ è½½åå•ä¸­...";

        try {
            // è·å–åå•
            const qRoster = new AV.Query('ClassRoster');
            const rosterData = await qRoster.first();
            if(!rosterData) { grid.innerHTML = "ç®¡ç†å‘˜æš‚æœªé…ç½®åå•"; return; }
            const students = rosterData.get('list');

            // è·å–ä»Šæ—¥å·²ç­¾åˆ°è®°å½• (é¿å…å¤šäººç‚¹åŒä¸€ä¸ª)
            const qToday = new AV.Query('SignInRecord');
            qToday.equalTo('date', todayStr);
            const todayRecords = await qToday.find();
            const signedSids = todayRecords.map(r => r.get('sid'));

            grid.innerHTML = "";
            
            students.forEach(stu => {
                const isSigned = signedSids.includes(stu.sid);
                const div = document.createElement('div');
                div.className = `student-card ${isSigned ? 'signed' : ''}`;
                div.innerHTML = `<div class="s-id">${stu.sid}</div><div class="s-name">${stu.name}</div>${isSigned ? '<div>å·²ç­¾</div>' : ''}`;
                
                if (!isSigned) {
                    div.onclick = () => doSign(stu.sid, stu.name, todayStr, div);
                }
                grid.appendChild(div);
            });

        } catch (e) {
            grid.innerHTML = "åŠ è½½å¤±è´¥";
        }
    }

    async function doSign(sid, name, dateStr, divEl) {
        // äºŒæ¬¡æ£€æŸ¥è®¾å¤‡é”
        if (localStorage.getItem('last_sign_date') === dateStr) {
            alert("âš ï¸ æœ¬æ‰‹æœºä»Šæ—¥å·²ç­¾åˆ°è¿‡ï¼Œæ— æ³•æ›¿ä»–äººç­¾åˆ°ï¼");
            return;
        }

        if(!confirm(`ç¡®è®¤æ˜¯ã€${name}ã€‘æœ¬äººå—ï¼Ÿ\nç­¾åˆ°åæœ¬æ‰‹æœºä»Šæ—¥å°†æ— æ³•å†ç­¾åˆ°ã€‚`)) return;

        // æäº¤æ•°æ®
        const Record = AV.Object.extend('SignInRecord');
        const r = new Record();
        r.set('sid', sid);
        r.set('name', name);
        r.set('date', dateStr);
        // r.set('ua', navigator.userAgent); // å¯é€‰ï¼šè®°å½•è®¾å¤‡ç‰¹å¾

        try {
            divEl.style.background = "#eee";
            divEl.innerText = "æäº¤ä¸­...";
            
            await r.save();
            
            // å†™å…¥è®¾å¤‡é”
            localStorage.setItem('last_sign_date', dateStr);
            
            // UIåé¦ˆ
            divEl.className = "student-card signed";
            divEl.innerHTML = `<div class="s-id">${sid}</div><div class="s-name">${name}</div><div>âœ” æˆåŠŸ</div>`;
            divEl.onclick = null;
            
            alert("âœ… ç­¾åˆ°æˆåŠŸï¼");
            document.getElementById('user-status').innerText = "âœ… æ‚¨ä»Šæ—¥å·²å®Œæˆç­¾åˆ°";

        } catch (e) {
            alert("ç­¾åˆ°å¤±è´¥ï¼š" + e.message);
            divEl.innerText = name; // æ¢å¤
        }
    }

    // è·ç¦»è®¡ç®—ç®—æ³•
    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6378137;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.round(R * c);
    }
</script>
</body>
</html>