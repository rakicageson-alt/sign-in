<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç°åœºç­¾åˆ°</title>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        .btn { display: block; width: 100%; padding: 12px; background: #07c160; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 15px; }
        .btn:disabled { background: #ccc; }
        .btn-outline { background: white; color: #07c160; border: 1px solid #07c160; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .status { text-align: center; padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold; }
        .success { background: #e6ffed; color: #07c160; }
        .error { background: #ffe6e6; color: #f56c6c; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .loading { text-align: center; color: #999; }
        #debug-info { font-size: 12px; color: #999; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <!-- é¡µé¢ A: ç®¡ç†å‘˜é¢æ¿ -->
    <div id="admin-panel" class="card hidden">
        <h2>æˆ‘æ˜¯ç®¡ç†è€…</h2>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            <p>å½“å‰å®šä½ç²¾åº¦ï¼š<span id="admin-acc">...</span> ç±³</p>
        </div>
        <button class="btn" onclick="initiateSign()">ğŸ“ è®¾å®šå½“å‰ä½ç½®ä¸ºç­¾åˆ°ç‚¹</button>
        
        <div id="share-area" class="hidden" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
            <p style="text-align: center;">ğŸ‘‡ å°†æ­¤é“¾æ¥å‘åˆ°ç¾¤é‡Œ ğŸ‘‡</p>
            <textarea id="share-link" style="width:100%; height:60px; padding:10px; font-size:14px; color:#555;" readonly></textarea>
            <button class="btn btn-outline" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
        </div>

        <div style="margin-top: 30px;">
            <h3>ğŸ“Š ç­¾åˆ°æ•°æ®æ±‡æ€»</h3>
            <button class="btn btn-outline" onclick="loadData()">åˆ·æ–°åˆ—è¡¨</button>
            <div id="data-table-container" style="overflow-x: auto;">
                <table id="data-table">
                    <thead><tr><th>å§“å</th><th>ç­çº§</th><th>è·ç¦»è¯¯å·®</th><th>æ—¶é—´</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- é¡µé¢ B: å­¦ç”Ÿç­¾åˆ°é¢æ¿ -->
    <div id="student-panel" class="card hidden">
        <h1>ç°åœºç­¾åˆ°</h1>
        <div class="status error" id="dist-status">æ­£åœ¨å®šä½ä¸­...</div>
        
        <div id="sign-form" class="hidden">
            <div class="input-group">
                <label>å§“å</label>
                <input type="text" id="s-name" placeholder="è¯·è¾“å…¥å§“å">
            </div>
            <div class="input-group">
                <label>ç­çº§</label>
                <input type="text" id="s-class" placeholder="è¯·è¾“å…¥ç­çº§">
            </div>
            <div class="input-group">
                <label>å­¦å·</label>
                <input type="text" id="s-no" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            <button class="btn" id="submit-btn" onclick="submitSign()">ç¡®è®¤ç­¾åˆ°</button>
        </div>
        <button class="btn btn-outline" onclick="checkLocation()" style="margin-top:10px;">åˆ·æ–°å®šä½</button>
    </div>

    <!-- é¡µé¢ C: ç­¾åˆ°æˆåŠŸ -->
    <div id="success-panel" class="card hidden" style="text-align: center;">
        <h2 style="color: #07c160;">âœ… ç­¾åˆ°æˆåŠŸ</h2>
        <p>æ‚¨çš„è®°å½•å·²æäº¤</p>
        <p style="font-size: 12px; color: #999;">è¯·å‹¿é‡å¤æäº¤</p>
    </div>

    <div id="debug-info">V2.0 Pure HTML</div>

<script>
    // ================= é…ç½®åŒºåŸŸ (è¯·ä¿®æ”¹è¿™é‡Œ) =================
    const LEANCLOUD_APP_ID = "0sXEX9TfcX0cmnpC8LW0urn8-gzGzoHsz";      // æ›¿æ¢ä¸º LeanCloud App ID
    const LEANCLOUD_APP_KEY = "cRbQkmMYvmbq6IZBkCqUi9cU";    // æ›¿æ¢ä¸º LeanCloud App Key
    const LEANCLOUD_SERVER_URL = "https://0sxex9tf.lc-cn-n1-shared.com"; // æ›¿æ¢ä¸º API åŸŸå
    // ========================================================

    // åˆå§‹åŒ– LeanCloud
    if(LEANCLOUD_APP_ID !== "ä½ çš„AppID"){
        AV.init({ appId: LEANCLOUD_APP_ID, appKey: LEANCLOUD_APP_KEY, serverURL: LEANCLOUD_SERVER_URL });
    }

    // å…¨å±€å˜é‡
    const urlParams = new URLSearchParams(window.location.search);
    const MODE = urlParams.get('mode'); // 'sign' or null(admin)
    const TARGET_LAT = parseFloat(urlParams.get('lat'));
    const TARGET_LNG = parseFloat(urlParams.get('lng'));
    const LIMIT_DIST = 500; // é™åˆ¶500ç±³

    // è®¡ç®—è·ç¦»å…¬å¼ (Haversine)
    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6378137; // åœ°çƒåŠå¾„
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.round(R * c);
    }

    // ä¸»é€»è¾‘å…¥å£
    window.onload = function() {
        if (!LEANCLOUD_APP_ID || LEANCLOUD_APP_ID === "ä½ çš„AppID") {
            alert("âš ï¸ è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½® LeanCloud AppIDï¼");
            return;
        }

        if (MODE === 'sign' && TARGET_LAT && TARGET_LNG) {
            // è¿›å…¥å­¦ç”Ÿç­¾åˆ°æ¨¡å¼
            document.getElementById('student-panel').classList.remove('hidden');
            // è‡ªåŠ¨å›å¡«
            const cached = JSON.parse(localStorage.getItem('user_info') || '{}');
            if(cached.name) document.getElementById('s-name').value = cached.name;
            if(cached.cls) document.getElementById('s-class').value = cached.cls;
            if(cached.no) document.getElementById('s-no').value = cached.no;
            checkLocation();
        } else {
            // è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼
            document.getElementById('admin-panel').classList.remove('hidden');
            // è·å–ç®¡ç†å‘˜å½“å‰ä½ç½®ç²¾åº¦
            navigator.geolocation.getCurrentPosition(res => {
                document.getElementById('admin-acc').innerText = Math.round(res.coords.accuracy);
            }, err => {
                document.getElementById('admin-acc').innerText = "è·å–å¤±è´¥";
                alert("è¯·å…è®¸å®šä½æƒé™");
            }, { enableHighAccuracy: true });
        }
    };

    // --- ç®¡ç†å‘˜åŠŸèƒ½ ---
    function initiateSign() {
        if (!navigator.geolocation) return alert('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
        
        const btn = document.querySelector('#admin-panel .btn');
        btn.innerText = "æ­£åœ¨è·å–é«˜ç²¾åº¦ä½ç½®...";
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);
                
                // ç”Ÿæˆé“¾æ¥ (å½“å‰é¡µé¢URL + å‚æ•°)
                const baseUrl = window.location.href.split('?')[0];
                const finalLink = `${baseUrl}?mode=sign&lat=${lat}&lng=${lng}`;
                
                document.getElementById('share-area').classList.remove('hidden');
                document.getElementById('share-link').value = finalLink;
                btn.innerText = "ğŸ“ è®¾å®šæˆåŠŸ (ä½ç½®å·²æ›´æ–°)";
                btn.disabled = false;
            },
            (error) => {
                alert("å®šä½å¤±è´¥ï¼š" + error.message);
                btn.innerText = "ğŸ“ é‡æ–°è®¾å®š";
                btn.disabled = false;
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    }

    function copyLink() {
        const copyText = document.getElementById("share-link");
        copyText.select();
        document.execCommand("copy");
        alert("é“¾æ¥å·²å¤åˆ¶ï¼Œå»å‘å¾®ä¿¡ç¾¤å§ï¼");
    }

    async function loadData() {
        const query = new AV.Query('SignRecord');
        query.descending('createdAt'); // æŒ‰æ—¶é—´å€’åº
        query.limit(100);
        
        try {
            const results = await query.find();
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            
            results.forEach(record => {
                const d = record.attributes;
                const time = record.createdAt.toLocaleTimeString();
                const row = `<tr>
                    <td>${d.name}</td>
                    <td>${d.class}</td>
                    <td>${d.distance}ç±³</td>
                    <td>${time}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            if(results.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">æš‚æ— æ•°æ®</td></tr>';
        } catch (error) {
            alert("è¯»å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥LeanCloudé…ç½®");
            console.error(error);
        }
    }

    // --- å­¦ç”ŸåŠŸèƒ½ ---
    let currentDist = 9999;

    function checkLocation() {
        const statusEl = document.getElementById('dist-status');
        const formEl = document.getElementById('sign-form');
        
        statusEl.innerText = "æ­£åœ¨è·å–å«æ˜Ÿå®šä½...";
        statusEl.className = "status error";

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const dist = getDistance(lat, lng, TARGET_LAT, TARGET_LNG);
                currentDist = dist;

                if (dist <= LIMIT_DIST) {
                    statusEl.innerText = `âœ… åœ¨èŒƒå›´å†… (è·ç¦» ${dist} ç±³)`;
                    statusEl.className = "status success";
                    formEl.classList.remove('hidden');
                } else {
                    statusEl.innerText = `â›”ï¸ è¶…å‡ºèŒƒå›´ (è·ç¦» ${dist} ç±³)\nè¯·ç§»åŠ¨åˆ°è€å¸ˆé™„è¿‘`;
                    statusEl.className = "status error";
                    formEl.classList.add('hidden');
                }
            },
            (error) => {
                statusEl.innerText = "âŒ å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰‹æœºGPSå’Œæƒé™";
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    }

    async function submitSign() {
        const name = document.getElementById('s-name').value.trim();
        const cls = document.getElementById('s-class').value.trim();
        const no = document.getElementById('s-no').value.trim();

        if(!name || !cls || !no) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

        // æœ¬åœ°ç¼“å­˜
        localStorage.setItem('user_info', JSON.stringify({name, cls, no}));

        const SignRecord = AV.Object.extend('SignRecord');
        const record = new SignRecord();
        
        record.set('name', name);
        record.set('class', cls);
        record.set('studentId', no);
        record.set('distance', currentDist);
        record.set('ua', navigator.userAgent); // ç®€æ˜“é˜²ä½œå¼Šï¼šè®°å½•è®¾å¤‡å‹å·

        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerText = "æäº¤ä¸­...";

        try {
            await record.save();
            document.getElementById('student-panel').classList.add('hidden');
            document.getElementById('success-panel').classList.remove('hidden');
        } catch (error) {
            alert("æäº¤å¤±è´¥ï¼š" + error.message);
            document.getElementById('submit-btn').disabled = false;
        }
    }
</script>
</body>
</html>