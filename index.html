<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­çº§è€ƒå‹¤ (æç®€ç‰ˆ)</title>
    <!-- LeanCloud SDK -->
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <!-- è®¾å¤‡æŒ‡çº¹åº“ (ç”¨äºé”å®šè®¾å¤‡) -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: #1f2d3d; text-align: center; }
        
        .btn { display: block; width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 6px; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        .btn-outline { background: white; color: #007aff; border: 1px solid #007aff; }

        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
        
        .table-wrapper { overflow-x: auto; border: 1px solid #ccc; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
        th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        td:first-child, th:first-child { position: sticky; left: 0; background: #fff; z-index: 20; border-right: 2px solid #ddd;} 
        th:first-child { background: #f8f9fa; z-index: 30; }
        
        .check-mark { color: green; font-weight: bold; font-size: 16px; }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 15px; }
        .student-card { border: 1px solid #eee; padding: 15px 5px; text-align: center; border-radius: 6px; background: #fff; cursor: pointer; user-select: none; }
        .student-card.signed { background: #e8ffea; border-color: #28a745; color: #28a745; pointer-events: none; }
        
        .s-id { font-size: 12px; color: #999; margin-bottom: 4px; }
        .s-name { font-weight: bold; font-size: 16px; }
        .hidden { display: none; }
        .status { padding: 10px; text-align: center; border-radius: 4px; margin-bottom: 10px; font-size: 14px; }
        .error { background: #fee; color: #d00; }
        .success { background: #efe; color: #0a0; }
        #share-link { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div id="admin-panel" class="card hidden">
        <h2>ğŸ“‹ è€ƒå‹¤ç®¡ç†</h2>
        
        <!-- 1. åå• -->
        <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
            <h3>1. åå•è®¾ç½®</h3>
            <textarea id="roster-input" placeholder="ç›´æ¥ç²˜è´´ï¼šå­¦å· å§“å"></textarea>
            <button class="btn btn-outline" onclick="importRoster()">æ›´æ–°åå•</button>
        </div>

        <!-- 2. å‘èµ· -->
        <div>
            <h3>2. å‘èµ·ç­¾åˆ° (30ç±³)</h3>
            <button class="btn" id="start-btn" onclick="startSign()">ğŸ“ é”å®šä½ç½®å¹¶ç”Ÿæˆé“¾æ¥</button>
            <div id="gps-status" style="font-size:12px; color:#666; text-align:center; margin-top:5px;">å®šä½ä¸­...</div>
            
            <div id="share-box" class="hidden" style="margin-top:10px;">
                <input type="text" id="share-link" readonly onclick="this.select()">
                <p style="font-size:12px; color:#ff3b30; text-align:center;">å¤åˆ¶é“¾æ¥å‘ç¾¤é‡Œ</p>
            </div>
        </div>

        <!-- 3. æŠ¥è¡¨ -->
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>3. è€ƒå‹¤æ±‡æ€»è¡¨</h3>
            <button class="btn btn-outline" onclick="loadReport()">åˆ·æ–°æŠ¥è¡¨</button>
            <div class="table-wrapper" style="margin-top:10px;">
                <table id="report-table"><tbody><tr><td style="padding:20px; color:#999;">ç‚¹å‡»åˆ·æ–°</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <!-- å­¦ç”Ÿé¢æ¿ -->
    <div id="student-panel" class="card hidden">
        <h2>ğŸ‘‹ ç°åœºç­¾åˆ°</h2>
        <div id="user-status" class="status">æ­£åœ¨å®šä½...</div>
        
        <div id="roster-list" class="hidden">
            <p style="text-align:center; color:#666; font-size:14px;">è¯·ç‚¹å‡» <b>æœ¬äººåå­—</b> ç­¾åˆ°<br><span style="font-size:12px; color:#ff3b30;">(æ¯å°è®¾å¤‡ä»…é™ç­¾åˆ° 1 æ¬¡)</span></p>
            <div class="student-grid" id="student-grid"></div>
        </div>
    </div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const LEANCLOUD_APP_ID = "0sXEX9TfcX0cmnpC8LW0urn8-gzGzoHsz";     
    const LEANCLOUD_APP_KEY = "cRbQkmMYvmbq6IZBkCqUi9cU";   
    const LEANCLOUD_SERVER_URL = "https://0sxex9tf.lc-cn-n1-shared.com";
    // ===========================================

    if(LEANCLOUD_APP_ID.includes("ä½ çš„AppID")) alert("è¯·é…ç½® AppID å’Œ Key");
    AV.init({ appId: LEANCLOUD_APP_ID, appKey: LEANCLOUD_APP_KEY, serverURL: LEANCLOUD_SERVER_URL });

    const urlParams = new URLSearchParams(window.location.search);
    const MODE = urlParams.get('mode');
    const TARGET_LAT = parseFloat(urlParams.get('lat'));
    const TARGET_LNG = parseFloat(urlParams.get('lng'));
    const LIMIT_DIST = 30; // 30ç±³èŒƒå›´

    window.onload = function() {
        if (MODE === 'sign' && TARGET_LAT && TARGET_LNG) {
            initStudentPage();
        } else {
            initAdminPage();
        }
    };

    // ================= ç®¡ç†å‘˜é€»è¾‘ =================

    function initAdminPage() {
        document.getElementById('admin-panel').classList.remove('hidden');
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                res => { document.getElementById('gps-status').innerText = `ç²¾åº¦: Â±${Math.round(res.coords.accuracy)}ç±³`; },
                err => { document.getElementById('gps-status').innerText = "âš ï¸ è¯·å…è®¸å®šä½"; }
            );
        }
    }

    async function importRoster() {
        const text = document.getElementById('roster-input').value.trim();
        if(!text) return alert("å†…å®¹ä¸ºç©º");
        const lines = text.split('\n');
        const students = [];
        lines.forEach(line => {
            const parts = line.trim().split(/[\t\s]+/);
            if(parts.length >= 2) students.push({ sid: parts[0], name: parts[1] });
        });
        if(students.length===0) return alert("æ ¼å¼é”™è¯¯");
        if(!confirm(`ç¡®è®¤è¦†ç›–æ›´æ–° ${students.length} äººåå•ï¼Ÿ`)) return;

        const Roster = AV.Object.extend('ClassRoster');
        const query = new AV.Query('ClassRoster');
        try {
            const old = await query.first();
            const rosterObj = old || new Roster();
            rosterObj.set('list', students);
            // å¼€æ”¾æƒé™
            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            rosterObj.setACL(acl);
            await rosterObj.save();
            alert("âœ… åå•å·²æ›´æ–°");
        } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
    }

    function startSign() {
        if (!navigator.geolocation) return alert('ä¸æ”¯æŒå®šä½');
        const btn = document.getElementById('start-btn');
        btn.disabled = true; btn.innerText = "è·å–ä¸­...";

        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            const baseUrl = window.location.href.split('?')[0];
            const url = `${baseUrl}?mode=sign&lat=${lat}&lng=${lng}`;
            
            document.getElementById('share-box').classList.remove('hidden');
            document.getElementById('share-link').value = url;
            btn.innerText = `âœ… é”å®šæˆåŠŸ`;
            btn.disabled = false;
        }, err => { alert("å®šä½å¤±è´¥"); btn.disabled = false; }, { enableHighAccuracy: true });
    }

    async function loadReport() {
        const table = document.getElementById('report-table');
        table.innerHTML = '<tbody><tr><td>åŠ è½½ä¸­...</td></tr></tbody>';
        try {
            const qRoster = new AV.Query('ClassRoster');
            const rosterData = await qRoster.first();
            if(!rosterData) return;
            const students = rosterData.get('list');
            const qRecord = new AV.Query('SignInRecord');
            qRecord.limit(1000); qRecord.ascending('date');
            const records = await qRecord.find();
            const dates = [...new Set(records.map(r => r.get('date')))];
            
            let html = `<thead><tr><th style="min-width:120px;">å­¦å· å§“å</th>${dates.map(d=>`<th>${d}</th>`).join('')}</tr></thead><tbody>`;
            students.forEach(stu => {
                html += `<tr><td style="text-align:left;font-weight:bold;">${stu.sid} ${stu.name}</td>`;
                dates.forEach(date => {
                    const hasSigned = records.find(r => r.get('date')===date && r.get('sid')===stu.sid);
                    html += `<td>${hasSigned ? '<span class="check-mark">âœ”</span>' : ''}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody>`;
            table.innerHTML = html;
        } catch (e) { table.innerHTML = "åŠ è½½å¤±è´¥"; }
    }

    // ================= å­¦ç”Ÿé€»è¾‘ =================

    async function initStudentPage() {
        document.getElementById('student-panel').classList.remove('hidden');
        const statusEl = document.getElementById('user-status');

        navigator.geolocation.getCurrentPosition(async pos => {
            const dist = getDistance(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LNG);
            if (dist > LIMIT_DIST) {
                statusEl.className = "status error";
                statusEl.innerText = `â›” è·ç¦»è¿‡è¿œ (${dist}ç±³)\nè¯·è¿›å…¥æ•™å®¤èŒƒå›´å†…`;
                return;
            }
            statusEl.className = "status success";
            statusEl.innerText = `ğŸ“ ä½ç½®ç¬¦åˆ`;
            await renderStudentList();
        }, err => {
            statusEl.className = "status error";
            statusEl.innerText = "âŒ å®šä½å¤±è´¥ï¼Œè¯·æˆæƒ";
        }, { enableHighAccuracy: true });
    }

    async function renderStudentList() {
        const grid = document.getElementById('student-grid');
        document.getElementById('roster-list').classList.remove('hidden');
        grid.innerHTML = "åŠ è½½ä¸­...";

        try {
            const qRoster = new AV.Query('ClassRoster');
            const rosterData = await qRoster.first();
            const students = rosterData.get('list');
            
            const todayStr = new Date().toLocaleDateString();
            const qToday = new AV.Query('SignInRecord');
            qToday.equalTo('date', todayStr);
            const todayRecords = await qToday.find();
            const signedSids = todayRecords.map(r => r.get('sid'));

            grid.innerHTML = "";
            students.forEach(stu => {
                const isSigned = signedSids.includes(stu.sid);
                const div = document.createElement('div');
                div.className = `student-card ${isSigned ? 'signed' : ''}`;
                div.innerHTML = `<div class="s-id">${stu.sid}</div><div class="s-name">${stu.name}</div><div>${isSigned?'âœ” å·²ç­¾':'ç‚¹å‡»ç­¾åˆ°'}</div>`;
                if (!isSigned) {
                    div.onclick = () => doSign(stu.sid, stu.name, todayStr, div);
                }
                grid.appendChild(div);
            });
        } catch (e) { grid.innerHTML = "åŠ è½½å¤±è´¥"; }
    }

    // è·å–è®¾å¤‡æŒ‡çº¹
    async function getDeviceId() {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        return result.visitorId;
    }

    async function doSign(sid, name, dateStr, divEl) {
        divEl.style.opacity = '0.5';
        divEl.style.pointerEvents = 'none';
        const oldText = divEl.innerHTML;
        divEl.innerText = "æ ¡éªŒä¸­...";

        try {
            // ============ ç®€å•è€Œä¸¥æ ¼çš„é˜²çº¿ ============

            // 1. å­¦å·é” (æ•°æ®åº“çº§)
            // æ— è®ºä½ æ¢ä»€ä¹ˆè®¾å¤‡ï¼Œåªè¦è¿™ä¸ªå­¦å·ä»Šå¤©åœ¨æ•°æ®åº“é‡Œäº†ï¼Œå°±ä¸èƒ½å†ç­¾ã€‚
            const qCheck = new AV.Query('SignInRecord');
            qCheck.equalTo('date', dateStr);
            qCheck.equalTo('sid', sid);
            if (await qCheck.count() > 0) throw new Error("ALREADY_SIGNED");

            // 2. è®¾å¤‡é” (æŒ‡çº¹çº§)
            // æ— è®ºä½ æ˜¯å¦æ¸…ç©ºç¼“å­˜ï¼Œåªè¦æ˜¯è¿™å°æœºå™¨ä»Šå¤©ç­¾è¿‡ä¸€æ¬¡ï¼Œå°±åºŸäº†ã€‚
            const deviceId = await getDeviceId();
            const qDevice = new AV.Query('SignInRecord');
            qDevice.equalTo('date', dateStr);
            qDevice.equalTo('deviceId', deviceId);
            
            if (await qDevice.count() > 0) {
                // å¦‚æœèƒ½æŸ¥åˆ°è¿™ä¸ªè®¾å¤‡ä»Šå¤©æœ‰è®°å½•ï¼Œç›´æ¥æŠ¥é”™
                throw new Error("â›” æœ¬è®¾å¤‡ä»Šæ—¥å·²å®Œæˆä¸€æ¬¡ç­¾åˆ°ï¼Œä¸å¯é‡å¤ä½¿ç”¨ã€‚");
            }

            // 3. å¼¹çª—ç¡®è®¤
            if(!confirm(`è¯·ç¡®è®¤èº«ä»½ï¼š\n\n${name} (${sid})\n\næ˜¯æœ¬äººå—ï¼Ÿ`)) throw new Error("CANCEL");

            // ============ æäº¤ ============
            const Record = AV.Object.extend('SignInRecord');
            const r = new Record();
            r.set('sid', sid);
            r.set('name', name);
            r.set('date', dateStr);
            r.set('deviceId', deviceId); // å­˜å…¥æŒ‡çº¹
            
            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            r.setACL(acl);
            await r.save();

            // æˆåŠŸ UI
            divEl.className = "student-card signed";
            divEl.style.opacity = '1';
            divEl.innerHTML = `<div class="s-id">${sid}</div><div class="s-name">${name}</div><div style="color:green">âœ” æˆåŠŸ</div>`;
            divEl.onclick = null;
            
            document.getElementById('user-status').innerText = `âœ… ${name} ç­¾åˆ°æˆåŠŸ`;
            alert(`âœ… ç­¾åˆ°æˆåŠŸï¼`);

        } catch (e) {
            if (e.message === "CANCEL") {
                divEl.innerHTML = oldText;
            } else if (e.message === "ALREADY_SIGNED") {
                divEl.className = "student-card signed";
                divEl.style.opacity = '1';
                divEl.innerHTML = `<div class="s-id">${sid}</div><div class="s-name">${name}</div><div>å·²ç­¾</div>`;
                alert("æç¤ºï¼šè¯¥å­¦å·ä»Šæ—¥å·²ç­¾è¿‡");
            } else {
                alert(e.message);
                divEl.innerHTML = oldText;
            }
            divEl.style.pointerEvents = 'auto';
            divEl.style.opacity = '1';
        }
    }

    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6378137;
        const dLat = (lat2 - lat1)*Math.PI/180;
        const dLng = (lng2 - lng1)*Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
        return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
</script>
</body>
</html>